# 实现默认设置和设置保存功能

## 1. 功能需求分析

### 1.1 用户需求
- 默认显示时间戳
- 默认启动日志模式
- 设置保存功能
- 确保不影响打包功能

### 1.2 技术分析
- **设置保存**：可以使用Qt的QSettings类实现
- **默认设置**：在构造函数中初始化复选框状态
- **打包影响**：QSettings使用系统注册表或配置文件，不会影响打包功能

## 2. 实现方案

### 2.1 修改mainwindow.cpp

#### 2.1.1 在构造函数中添加默认设置
```cpp
// 设置初始状态
pushButton_open->setText("打开串口");
label_status->setText("串口未打开");
label_status->setStyleSheet("color: red;");
label_sendCount->setText("发送: 0 字节");
label_receiveCount->setText("接收: 0 字节");

// 默认显示时间戳和日志模式
checkBox_timestamp->setChecked(true);
checkBox_logMode->setChecked(true);
```

#### 2.1.2 添加设置保存和加载功能
1. **添加头文件**：
```cpp
#include <QSettings>
```

2. **修改构造函数，添加设置加载**：
```cpp
// 加载设置
QSettings settings("QtSerialTool", "Config");
checkBox_timestamp->setChecked(settings.value("timestamp", true).toBool());
checkBox_logMode->setChecked(settings.value("logMode", true).toBool());
checkBox_hexReceive->setChecked(settings.value("hexReceive", false).toBool());
checkBox_hexSend->setChecked(settings.value("hexSend", false).toBool());
```

3. **添加设置保存槽函数**：
```cpp
void MainWindow::saveSettings()
{
    QSettings settings("QtSerialTool", "Config");
    settings.setValue("timestamp", checkBox_timestamp->isChecked());
    settings.setValue("logMode", checkBox_logMode->isChecked());
    settings.setValue("hexReceive", checkBox_hexReceive->isChecked());
    settings.setValue("hexSend", checkBox_hexSend->isChecked());
}
```

4. **连接信号槽，实现设置自动保存**：
```cpp
// 在initUI()方法的信号槽连接部分添加
connect(checkBox_timestamp, &QCheckBox::stateChanged, this, &MainWindow::saveSettings);
connect(checkBox_logMode, &QCheckBox::stateChanged, this, &MainWindow::saveSettings);
connect(checkBox_hexReceive, &QCheckBox::stateChanged, this, &MainWindow::saveSettings);
connect(checkBox_hexSend, &QCheckBox::stateChanged, this, &MainWindow::saveSettings);
```

### 2.2 修改mainwindow.h

#### 2.2.1 添加saveSettings槽函数声明
```cpp
private slots:
    // 现有槽函数...
    void saveSettings();
```

## 3. 对打包功能的影响分析

### 3.1 配置文件位置
- QSettings在Windows上默认使用注册表，不会生成额外的配置文件
- 对于便携版，可以修改QSettings为使用INI文件，放在程序目录

### 3.2 打包兼容性
- **Enigma Virtual Box**：支持注册表虚拟化，不会影响打包
- **便携版方案**：可以修改QSettings为使用相对路径的INI文件，便于打包

### 3.3 解决方案
- 提供两种打包方案：
  1. **注册表版**：使用默认QSettings，适合安装版
  2. **便携版**：修改QSettings为使用程序目录下的INI文件，适合单文件打包

## 4. 预期效果

### 4.1 默认设置
- 启动程序后，自动勾选"显示时间戳"和"日志模式"
- 用户可以手动取消勾选，设置会自动保存

### 4.2 设置保存
- 所有设置自动保存到系统注册表
- 下次启动时自动加载上次的设置

### 4.3 打包影响
- 不影响现有打包流程
- 支持多种打包方式

## 5. 实现步骤

1. 修改mainwindow.h，添加saveSettings槽函数声明
2. 修改mainwindow.cpp，添加QSettings头文件
3. 在构造函数中添加默认设置和设置加载
4. 实现saveSettings槽函数
5. 连接信号槽，实现设置自动保存
6. 测试功能完整性
7. 测试打包功能兼容性

## 6. 注意事项

### 6.1 打包兼容性
- 对于Enigma Virtual Box打包，默认注册表方案无影响
- 对于便携版打包，需要修改QSettings为INI文件方案

### 6.2 配置文件管理
- 如果使用INI文件，需要确保程序有写入权限
- 打包时需要包含INI文件模板

### 6.3 版本兼容性
- QSettings在不同Qt版本中表现一致，不会影响兼容性

## 7. 结论

实现默认设置和设置保存功能不会影响打包功能，具体方案如下：
- 默认使用QSettings注册表方案，适合大多数打包工具
- 提供便携版选项，使用INI文件方案
- 保持代码模块化，便于切换不同的设置保存方案

这个实现方案既满足了用户需求，又确保了与打包功能的兼容性。